<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Game - Quá»¹ TÃ­n Dá»¥ng TÃ¢y SÃ i GÃ²n</title>
<style>
  :root{--primary:#2e7d32;--accent:#ffb300;--card:#ffffffcc}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#e8f5e9,#fff);display:flex;min-height:100vh;align-items:center;justify-content:center;padding:16px}
  .wrap{width:100%;max-width:420px;background:var(--card);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,0.12);padding:18px;text-align:center}
  h1{margin:6px 0;color:var(--primary);font-size:20px}
  p.lead{font-size:14px;color:#333;margin:8px 0 14px}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:16px;box-sizing:border-box;margin:8px 0}
  button.primary{width:100%;padding:12px;border-radius:10px;border:none;background:var(--primary);color:#fff;font-size:16px;cursor:pointer}
  button.secondary{width:100%;padding:10px;border-radius:10px;border:1px solid #eee;background:#fff;margin-top:8px;cursor:pointer}
  .question{margin-top:14px}
  .opt{display:block;width:100%;padding:12px;border-radius:10px;border:none;margin:8px 0;font-size:16px;cursor:pointer}
  .opt.correct{background:linear-gradient(90deg,#b9f6ca,#69f0ae);color:#004d00}
  .opt.wrong{background:linear-gradient(90deg,#ffcdd2,#ff8a80);color:#5d0000}
  .message{margin-top:12px;font-weight:bold}
  #canvasConfetti{position:fixed;left:0;top:0;pointer-events:none;z-index:9999}
  .musicControl{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
  small.note{display:block;color:#555;margin-top:8px}
</style>
</head>
<body>
<div class="wrap" id="app">
  <h1>ğŸ‰ Mini Game - Quá»¹ TÃ­n Dá»¥ng TÃ¢y SÃ i GÃ²n</h1>
  <p class="lead">ChÃ o má»«ng báº¡n tham gia mini game cÃ¹ng vá»›i Quá»¹ TÃ­n Dá»¥ng TÃ¢y SÃ i GÃ²n</p>

  <div id="step-phone">
    <input id="phone" type="tel" placeholder="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i (báº¯t buá»™c)" />
    <button class="primary" id="btnStart">Báº¯t Ä‘áº§u</button>
    <div style="height:8px"></div>
    <div class="musicControl">
      <button class="secondary" id="btnPlayMusic">â–¶ Báº­t nháº¡c</button>
      <button class="secondary" id="btnStopMusic">â¸ Táº¯t nháº¡c</button>
    </div>
    <small class="note">Nháº¡c báº­t báº±ng tay Ä‘á»ƒ khÃ´ng bá»‹ cháº·n trÃªn Ä‘iá»‡n thoáº¡i.</small>
    <p id="phoneMsg" style="color:#b00020;margin-top:8px"></p>
  </div>

  <div id="step-game" style="display:none">
    <div id="welcomeText">
      <p style="margin:6px 0">ğŸª… <b>ChÃ o má»«ng báº¡n tham gia mini game cÃ¹ng vá»›i Quá»¹ TÃ­n Dá»¥ng TÃ¢y SÃ i GÃ²n</b></p>
    </div>

    <div id="q1" class="question">
      <p><b>CÃ¢u 1:</b> Quá»¹ TÃ­n Dá»¥ng TÃ¢y SÃ i GÃ²n Ä‘Ã£ hoáº¡t Ä‘á»™ng Ä‘Æ°á»£c bao nhiÃªu nÄƒm?</p>
      <button class="opt" onclick="choose(1,'5 nÄƒm')">5 nÄƒm</button>
      <button class="opt" onclick="choose(1,'10 nÄƒm')">10 nÄƒm</button>
      <button class="opt" onclick="choose(1,'18 nÄƒm')">18 nÄƒm</button>
    </div>

    <div id="q2" class="question" style="display:none">
      <p><b>CÃ¢u 2:</b> LÃ£i suáº¥t tiáº¿t kiá»‡m ká»³ háº¡n 13 thÃ¡ng táº¡i Quá»¹ TÃ¢y SÃ i GÃ²n lÃ  bao nhiÃªu?</p>
      <button class="opt" onclick="choose(2,'5%')">5%</button>
      <button class="opt" onclick="choose(2,'5.5%')">5.5%</button>
      <button class="opt" onclick="choose(2,'6.2%')">6.2%</button>
    </div>

    <div id="resultBox" style="display:none">
      <p id="resultMsg" class="message"></p>
      <p style="font-size:14px;color:#333">Xin má»i quÃ½ khÃ¡ch Ä‘áº¿n Quá»¹ TD TÃ¢y SÃ i GÃ²n táº¡i <b>2276 VÄ©nh Lá»™c</b> Ä‘á»ƒ nháº­n quÃ  nhÃ©.</p>
      <button class="primary" onclick="restart()">ChÆ¡i láº¡i</button>
    </div>
  </div>
</div>

<canvas id="canvasConfetti"></canvas>
<audio id="bgMusic" loop>
  <!-- Náº¿u báº¡n cÃ³ link mp3, thay vÃ o src dÆ°á»›i Ä‘Ã¢y -->
  <source src="" type="audio/mpeg">
</audio>

<script>
/* --- Cáº¥u hÃ¬nh: dÃ¡n URL Web App Google Script táº¡i Ä‘Ã¢y --- */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxF4evPvBJ_gtC5qtufqbvw0rG9gSJjW3UYZSAADJUoOBmKjAF_prCuYc89PZiNjcqM/exec";

/* ÄÃ¡p Ã¡n Ä‘Ãºng theo yÃªu cáº§u áº£nh */
const answers = {
  1: "18 nÄƒm",
  2: "6.2%"
};

let phone = "";
let answersUser = {1: "", 2: ""};
let currentQ = 1;
const phoneInput = document.getElementById('phone');
const phoneMsg = document.getElementById('phoneMsg');

document.getElementById('btnStart').addEventListener('click', async function(){
  phoneMsg.textContent = "";
  phone = phoneInput.value.trim();
  if(!phone.match(/^[0-9]{7,12}$/)){
    phoneMsg.textContent = "Vui lÃ²ng nháº­p sá»‘ Ä‘iá»‡n thoáº¡i há»£p lá»‡ (7-12 chá»¯ sá»‘).";
    return;
  }
  // gá»i API check
  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ action: "check", sdt: phone }),
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    if (data.status === "exists") {
      phoneMsg.textContent = "Sá»‘ Ä‘iá»‡n thoáº¡i nÃ y Ä‘Ã£ tham gia rá»“i. Cáº£m Æ¡n báº¡n!";
      return;
    }
    // náº¿u ok -> báº¯t Ä‘áº§u game
    document.getElementById('step-phone').style.display = 'none';
    document.getElementById('step-game').style.display = 'block';
  } catch (err) {
    phoneMsg.textContent = "Lá»—i káº¿t ná»‘i, vui lÃ²ng thá»­ láº¡i.";
    console.error(err);
  }
});

/* xá»­ lÃ½ chá»n Ä‘Ã¡p Ã¡n */
function choose(qnum, val){
  // disable cÃ¡c nÃºt cá»§a cÃ¢u Ä‘Ã³ Ä‘á»ƒ trÃ¡nh báº¥m thÃªm
  const qEl = document.getElementById('q'+qnum);
  Array.from(qEl.querySelectorAll('.opt')).forEach(btn => btn.disabled = true);

  answersUser[qnum] = val;

  // hiá»ƒn thá»‹ Ä‘Ã¡p Ã¡n Ä‘Ãºng/ sai ngay láº­p tá»©c vÃ  hiá»‡u á»©ng
  const correct = (val === answers[qnum]);
  if (correct) {
    // highlight nÃºt Ä‘Æ°á»£c chá»n
    highlightButton(qEl, val, true);
    showResultMessage(true, qnum);
  } else {
    highlightButton(qEl, val, false);
    showResultMessage(false, qnum);
  }

  // náº¿u cÃ²n cÃ¢u tiáº¿p theo -> chuyá»ƒn sang cÃ¢u sau
  if (qnum === 1) {
    setTimeout(()=> {
      document.getElementById('q1').style.display = 'none';
      document.getElementById('q2').style.display = 'block';
      currentQ = 2;
    }, 900);
  } else {
    // cÃ¢u cuá»‘i -> gá»­i káº¿t quáº£ lÃªn server vÃ  hiá»ƒn thá»‹ káº¿t quáº£ chung
    setTimeout(()=> finishGame(), 900);
  }
}

function highlightButton(qEl, val, isCorrect){
  Array.from(qEl.querySelectorAll('.opt')).forEach(btn=>{
    if (btn.textContent.trim() === val) {
      btn.classList.add(isCorrect ? 'correct' : 'wrong');
    }
  });
}

function showResultMessage(isCorrect, qnum){
  // theo ná»™i dung báº¡n muá»‘n: náº¿u sai váº«n tung bÃ´ng, náº¿u Ä‘Ãºng tung nhiá»u hÆ¡n
  // á»Ÿ Ä‘Ã¢y chÃºng ta chá»‰ hiá»ƒn thá»‹ message cuá»‘i cÃ¹ng, cÃ²n confetti sáº½ cháº¡y á»Ÿ cuá»‘i
  const msg = isCorrect
    ? `ğŸ‰ Tung bÃ´ng hoa nhiá»u hÆ¡n, Wow, báº¡n giá»i quÃ¡! (CÃ¢u ${qnum} Ä‘Ãºng)`
    : `ğŸˆ Váº«n tung bÃ´ng, chÃºc má»«ng báº¡n, chÆ°a chÃ­nh xÃ¡c nhÆ°ng báº¡n váº«n cÃ³ quÃ  nhÃ©. (CÃ¢u ${qnum} sai)`;
  // táº¡m show toast nhá»
  showToast(msg);
}

/* khi hoÃ n táº¥t */
async function finishGame(){
  // gá»i API submit
  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "submit",
        sdt: phone,
        cau1: answersUser[1],
        cau2: answersUser[2]
      }),
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    // hiá»ƒn thá»‹ káº¿t quáº£ tá»•ng quÃ¡t
    const isAllCorrect = (answersUser[1] === answers[1] && answersUser[2] === answers[2]);
    const resultBox = document.getElementById('resultBox');
    const resultMsg = document.getElementById('resultMsg');

    if (isAllCorrect) {
      resultMsg.innerHTML = "ğŸ‰ ChÃºc má»«ng báº¡n Ä‘Ã£ chÃ­nh xÃ¡c cáº£ 2 cÃ¢u! Báº¡n nháº­n Ä‘Æ°á»£c 1 phiáº¿u Ä‘áº·c biá»‡t táº¡i Phá»Ÿ Sinh ÄÃ´i.";
    } else {
      // Náº¿u 1 trong 2 sai, nÃªu rÃµ Ä‘Ã¡p Ã¡n Ä‘áº§y Ä‘á»§
      let text = "ğŸ˜Š CÃ¡m Æ¡n báº¡n! Káº¿t quáº£: ";
      text += `<br>CÃ¢u 1 Ä‘Ãºng: <b>${answers[1]}</b>. Báº¡n tráº£ lá»i: <b>${answersUser[1]||'(bá» trá»‘ng)'}</b>`;
      text += `<br>CÃ¢u 2 Ä‘Ãºng: <b>${answers[2]}</b>. Báº¡n tráº£ lá»i: <b>${answersUser[2]||'(bá» trá»‘ng)'}</b>`;
      resultMsg.innerHTML = text;
    }

    // hiá»ƒn thá»‹ result vÃ  cháº¡y hiá»‡u á»©ng confetti
    document.getElementById('q2').style.display = 'none';
    resultBox.style.display = 'block';
    runConfetti(isAllCorrect ? 120 : 70);

  } catch (err) {
    showToast("Lá»—i lÆ°u káº¿t quáº£. Vui lÃ²ng thá»­ láº¡i.");
    console.error(err);
  }
}

/* restart */
function restart(){
  window.location.reload();
}

/* nhá»: hiá»ƒn thá»‹ toast */
function showToast(txt){
  const d = document.createElement('div');
  d.textContent = txt;
  d.style.position = 'fixed';
  d.style.left = '50%';
  d.style.transform = 'translateX(-50%)';
  d.style.bottom = '40px';
  d.style.background = '#333';
  d.style.color = '#fff';
  d.style.padding = '10px 16px';
  d.style.borderRadius = '8px';
  d.style.zIndex = 9999;
  document.body.appendChild(d);
  setTimeout(()=> d.style.opacity = '0', 2500);
  setTimeout(()=> d.remove(), 3000);
}

/* --- Confetti Ä‘Æ¡n giáº£n báº±ng canvas --- */
const canvas = document.getElementById('canvasConfetti');
const ctx = canvas.getContext('2d');
function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function runConfetti(particlesCount){
  let particles = [];
  for (let i=0;i<particlesCount;i++){
    particles.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height/2,
      vx: (Math.random()-0.5)*6,
      vy: Math.random()*6 + 2,
      r: Math.random()*6+3,
      color: `hsl(${Math.random()*360},70%,60%)`,
      life: Math.random()*80+40
    });
  }
  let raf;
  function frame(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for (let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.12; // gravity
      p.life--;
      ctx.fillStyle = p.color;
      ctx.fillRect(p.x, p.y, p.r, p.r*0.6);
      if (p.life<=0 || p.y>canvas.height){
        particles.splice(i,1);
      }
    }
    if (particles.length>0) raf = requestAnimationFrame(frame); else cancelAnimationFrame(raf);
  }
  frame();
}

/* --- Nháº¡c ná»n: ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ chÃ¨n src vÃ o tháº» audio --- */
const audio = document.getElementById('bgMusic');
document.getElementById('btnPlayMusic').addEventListener('click', function(){
  // náº¿u chÆ°a cÃ³ src, thÃ´ng bÃ¡o cÃ¡ch thÃªm
  if (!audio.querySelector('source') || !audio.querySelector('source').src) {
    showToast("Äá»ƒ báº­t nháº¡c, hÃ£y chá»‰nh src audio trong mÃ£ (file mp3 cÃ´ng khai).");
    return;
  }
  audio.play().catch(err=>showToast("TrÃ¬nh duyá»‡t cháº·n autoplay, vui lÃ²ng áº¥n Play."));
});
document.getElementById('btnStopMusic').addEventListener('click', function(){ audio.pause(); });

</script>
</body>
</html>
